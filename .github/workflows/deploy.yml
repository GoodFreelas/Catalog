name: üöÄ Deploy Cat√°logo Tiny (Create React App)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "18"
  CACHE_VERSION: "v1"

jobs:
  # ===============================
  # JOB 1: AN√ÅLISE E TESTES
  # ===============================
  test:
    name: üß™ Testes e An√°lise
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üîß Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # Cache personalizado para node_modules
      - name: üíæ Cache node_modules Backend
        uses: actions/cache@v3
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-backend-${{ env.CACHE_VERSION }}-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-backend-${{ env.CACHE_VERSION }}-

      - name: üíæ Cache node_modules Frontend
        uses: actions/cache@v3
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-frontend-${{ env.CACHE_VERSION }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-${{ env.CACHE_VERSION }}-

      # Cache do build do Create React App
      - name: üíæ Cache Build CRA
        uses: actions/cache@v3
        with:
          path: |
            frontend/build
            frontend/.cache
          key: ${{ runner.os }}-cra-build-${{ hashFiles('frontend/src/**/*') }}
          restore-keys: |
            ${{ runner.os }}-cra-build-

      # Instalar depend√™ncias
      - name: üì¶ Instalar depend√™ncias Backend
        run: |
          cd backend
          npm ci --prefer-offline --no-audit

      - name: üì¶ Instalar depend√™ncias Frontend
        run: |
          cd frontend
          npm ci --prefer-offline --no-audit

      # Verifica√ß√µes de c√≥digo
      - name: üîç Lint Backend
        run: |
          cd backend
          npm run lint || echo "‚ö†Ô∏è Lint n√£o configurado no backend"

      - name: üîç Lint Frontend
        run: |
          cd frontend
          npm run lint || npx eslint src/ || echo "‚ö†Ô∏è Executando lint padr√£o"

      # Testes
      - name: üß™ Testes Backend
        run: |
          cd backend
          npm test || echo "‚ö†Ô∏è Testes n√£o configurados no backend"

      - name: üß™ Testes Frontend (Create React App)
        run: |
          cd frontend
          npm test -- --coverage --verbose --watchAll=false
        env:
          CI: true

      # Build do frontend Create React App
      - name: üèóÔ∏è Build Frontend (Create React App)
        run: |
          cd frontend
          npm run build
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'http://localhost:3001/api' }}
          REACT_APP_WHATSAPP_NUMBER: ${{ secrets.REACT_APP_WHATSAPP_NUMBER || '5551999999999' }}
          REACT_APP_STORE_NAME: ${{ secrets.REACT_APP_STORE_NAME || 'Minha Loja' }}
          REACT_APP_STORE_LOGO: ${{ secrets.REACT_APP_STORE_LOGO || '/assets/logo.png' }}
          GENERATE_SOURCEMAP: false
          PUBLIC_URL: ${{ secrets.FRONTEND_URL || '' }}

      # Upload dos artefatos de build
      - name: üì§ Upload Frontend Build
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: frontend/build
          retention-days: 1

  # ===============================
  # JOB 2: DEPLOY BACKEND
  # ===============================
  deploy-backend:
    name: üîß Deploy Backend
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: production-backend
      url: ${{ steps.deploy.outputs.app-url }}

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      # Deploy para Heroku
      - name: üöÄ Deploy para Heroku
        id: deploy
        uses: akhileshns/heroku-deploy@v3.12.14
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: "backend"
          procfile: "web: npm start"
          healthcheck: "https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com/health"
          checkstring: "ok"
          delay: 5

      # Configurar vari√°veis de ambiente no Heroku
      - name: ‚öôÔ∏è Configurar vari√°veis Heroku
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

          heroku config:set \
            TINY_CLIENT_ID="${{ secrets.TINY_CLIENT_ID }}" \
            TINY_CLIENT_SECRET="${{ secrets.TINY_CLIENT_SECRET }}" \
            FRONTEND_URL="${{ secrets.FRONTEND_URL }}" \
            NODE_ENV=production \
            NPM_CONFIG_PRODUCTION=false \
            -a ${{ secrets.HEROKU_APP_NAME }}
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

      # Verificar sa√∫de do backend
      - name: üè• Health Check Backend
        run: |
          echo "üîç Verificando sa√∫de do backend..."
          for i in {1..10}; do
            if curl -s "https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com/health" | grep -q "ok"; then
              echo "‚úÖ Backend est√° saud√°vel!"
              exit 0
            fi
            echo "‚è≥ Tentativa $i/10..."
            sleep 10
          done
          echo "‚ùå Backend n√£o respondeu corretamente"
          exit 1

  # ===============================
  # JOB 3: DEPLOY FRONTEND (CRA)
  # ===============================
  deploy-frontend:
    name: üé® Deploy Frontend (Create React App)
    needs: [test, deploy-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: production-frontend
      url: ${{ steps.deploy.outputs.preview-url }}

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üîß Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      # Download do build anterior (se dispon√≠vel)
      - name: üì• Download Frontend Build
        uses: actions/download-artifact@v3
        with:
          name: frontend-build
          path: frontend/build
        continue-on-error: true

      - name: üì¶ Instalar depend√™ncias
        run: |
          cd frontend
          npm ci --prefer-offline --no-audit

      # Build final Create React App com vari√°veis de produ√ß√£o
      - name: üèóÔ∏è Build Create React App Produ√ß√£o
        run: |
          cd frontend
          npm run build
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_WHATSAPP_NUMBER: ${{ secrets.REACT_APP_WHATSAPP_NUMBER }}
          REACT_APP_STORE_NAME: ${{ secrets.REACT_APP_STORE_NAME }}
          REACT_APP_STORE_LOGO: ${{ secrets.REACT_APP_STORE_LOGO }}
          GENERATE_SOURCEMAP: false
          PUBLIC_URL: ${{ secrets.FRONTEND_URL }}
          BUILD_PATH: build

      # Deploy para Vercel
      - name: üöÄ Deploy para Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: "--prod"
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: frontend
          github-comment: false

      # Alternativa: Deploy para Netlify
      - name: üåê Deploy para Netlify (alternativo)
        if: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        uses: nwtgck/actions-netlify@v2.1
        with:
          publish-dir: "./frontend/build"
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - Create React App"
          enable-pull-request-comment: false
          enable-commit-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # Deploy est√°tico para GitHub Pages (alternativo)
      - name: üìÑ Deploy para GitHub Pages
        if: ${{ secrets.GITHUB_TOKEN && !secrets.VERCEL_TOKEN }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./frontend/build
          cname: ${{ secrets.CUSTOM_DOMAIN }}

      # Verificar se frontend est√° funcionando
      - name: üîç Verificar Frontend
        run: |
          echo "üîç Verificando frontend..."
          if [ -n "${{ steps.deploy.outputs.preview-url }}" ]; then
            URL="${{ steps.deploy.outputs.preview-url }}"
          else
            URL="${{ secrets.FRONTEND_URL }}"
          fi

          for i in {1..5}; do
            if curl -s "$URL" | grep -q "<title>"; then
              echo "‚úÖ Frontend est√° funcionando!"
              echo "üåê URL: $URL"
              exit 0
            fi
            echo "‚è≥ Tentativa $i/5..."
            sleep 5
          done
          echo "‚ö†Ô∏è Frontend pode n√£o estar respondendo corretamente"

  # ===============================
  # JOB 4: TESTES DE INTEGRA√á√ÉO
  # ===============================
  integration-tests:
    name: üîó Testes de Integra√ß√£o
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      # Testes E2E espec√≠ficos para Create React App
      - name: üß™ Testes de API
        run: |
          echo "üîç Testando endpoints do backend..."

          BACKEND_URL="https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com"

          # Teste de health
          echo "Testing health endpoint..."
          curl -f "$BACKEND_URL/health" || exit 1

          # Teste de status
          echo "Testing status endpoint..."
          curl -f "$BACKEND_URL/api/status" || exit 1

          echo "‚úÖ Todos os testes de API passaram!"

      - name: üåê Teste Frontend-Backend (Create React App)
        run: |
          echo "üîç Testando comunica√ß√£o frontend-backend..."

          BACKEND_URL="https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com"

          # Teste CORS espec√≠fico para Create React App
          curl -H "Origin: ${{ secrets.FRONTEND_URL }}" \
               -H "Access-Control-Request-Method: GET" \
               -H "Access-Control-Request-Headers: Content-Type" \
               -X OPTIONS \
               "$BACKEND_URL/api/status" || exit 1

          echo "‚úÖ Comunica√ß√£o frontend-backend OK!"

      # Teste de performance do build CRA
      - name: üìä An√°lise de Performance (CRA)
        run: |
          echo "üìä Analisando performance do build Create React App..."

          # Verificar tamanho do bundle
          if [ -d "frontend/build/static/js" ]; then
            echo "üì¶ Tamanhos dos arquivos JavaScript:"
            ls -lh frontend/build/static/js/*.js
            
            # Verificar se bundle n√£o est√° muito grande (>2MB)
            BUNDLE_SIZE=$(du -sm frontend/build/static/js | cut -f1)
            if [ "$BUNDLE_SIZE" -gt 2 ]; then
              echo "‚ö†Ô∏è Bundle JavaScript muito grande: ${BUNDLE_SIZE}MB"
            else
              echo "‚úÖ Tamanho do bundle OK: ${BUNDLE_SIZE}MB"
            fi
          fi

  # ===============================
  # JOB 5: NOTIFICA√á√ïES
  # ===============================
  notify:
    name: üì¢ Notifica√ß√µes
    needs: [deploy-backend, deploy-frontend, integration-tests]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: üìä Status do Deploy
        run: |
          echo "üìä Resumo do Deploy Create React App:"
          echo "Backend: ${{ needs.deploy-backend.result }}"
          echo "Frontend: ${{ needs.deploy-frontend.result }}"
          echo "Integra√ß√£o: ${{ needs.integration-tests.result }}"

      # Notifica√ß√£o de sucesso
      - name: ‚úÖ Notificar Sucesso
        if: needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success'
        run: |
          echo "üéâ Deploy Create React App realizado com sucesso!"
          echo "üîß Backend: https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com"
          echo "üé® Frontend: ${{ secrets.FRONTEND_URL }}"
          echo "‚ö° Tecnologia: Create React App"
          echo "‚è∞ Hor√°rio: $(date)"

      # Notifica√ß√£o de falha
      - name: ‚ùå Notificar Falha
        if: needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure'
        run: |
          echo "‚ùå Falha no deploy Create React App!"
          echo "Backend Status: ${{ needs.deploy-backend.result }}"
          echo "Frontend Status: ${{ needs.deploy-frontend.result }}"
          exit 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
